<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Cropper</title>
<style>
body {
	background-color: rgb(240,255,255); /* Azure */
	font-family: verdana;
	font-size: 10pt;
}
input, select {
	font-family: verdana;
	font-size: 10pt;
	margin-top: 2px;
	margin-bottom: 2px;
}
#statusDiv {
	background-color: rgb(230,230,250); /* Lavender */
	border: 2px solid black;
	border-radius: 10px;
	display: none;
	font-size: 14pt;
	text-align: center;
	padding: 10px;
	position: absolute;
}
#statusText {
	position: relative;
	top: -10px;
	padding-right: 12px;
}
@keyframes spinDiscAnimation {
	from { transform: rotateZ(0deg); }
	to { transform: rotateZ(360deg); }
}
#spinDisc {
	display: inline-block;
	width: 0px;
	height: 0px;

	border-top: 20px solid rgb(65,105,225); /* RoyalBlue */
	border-left: 20px solid rgb(135,206,250); /* LightSkyBlue */
	border-bottom: 20px solid rgb(65,105,225); /* RoyalBlue */
	border-right: 20px solid rgb(135,206,250); /* LightSkyBlue */
	border-radius: 20px;

	animation-name: spinDiscAnimation;
	animation-duration: 1.5s;
	animation-iteration-count: infinite;
	animation-timing-function: linear;
	animation-play-state: paused;
}
#controlDiv {
	background-color: rgba(230,230,250,0.8);
	border: 2px solid black;
	border-radius: 10px;
	text-align: center;
	width: 520px;
	padding: 2px;
	position: absolute;
	left: 52px;
	top: 422px;
}
#photoDiv {
	position: relative;
	overflow: hidden;
	width: 600px;
	height: 400px;
	border: 4px solid black;
}
#photo {
	position: absolute;
	left: 0px;
	top: 0px;
	width: 600px;
	height: 400px;
}
#cropper {
	position: absolute;
	width: 596px; /* 600 with the border */
	height: 396px; /* 400 with the border */
	top: 12px;
	left: 12px;
	border: 2px dashed black;
	cursor: move;
}
#resizeNW {
	position: absolute;
	width: 20px;
	height: 20px;
	top: -10px;
	left: -10px;
	cursor: nw-resize;
}
#resizeNE {
	position: absolute;
	width: 20px;
	height: 20px;
	top: -10px;
	right: -10px;
	cursor: ne-resize;
}
#resizeSW {
	position: absolute;
	width: 20px;
	height: 20px;
	bottom: -10px;
	left: -10px;
	cursor: sw-resize;
}
#resizeSE {
	position: absolute;
	width: 20px;
	height: 20px;
	bottom: -10px;
	right: -10px;
	cursor: se-resize;
}
a {
	text-decoration: none;
}
a:hover {
	color: rgb(218,69,0);
}
#filterDiv table {
	margin-left: auto;
	margin-right: auto;
	border-spacing: 0;
}
#filterDiv td {
	padding-left: 4px;
	padding-right: 4px;
	text-align: left;
}
.clickable {
	font-size: 12pt;
	padding-left: 2px;
	padding-right: 2px;
	text-align: center;
}
.clickable:hover {
	background-color: rgb(136,136,136);
	color: rgb(255,255,255);
	cursor: pointer;
}
#fileBrowser {
	display: none;
}
input[type="range"] {
	vertical-align: middle;
	width: 180px;
}
#canvas {
	border: 4px solid black;
	display: none;
	margin-top: 4px;
}
#downloadLink {
	display: none;
}
</style>
<script src="cropList.js"></script>
<script>
var originalWidth;
var originalHeight;
var aspectX;
var aspectY;
var startX;
var startY;
var multiplyX;
var multiplyY;
var rotateAngle;
var photoLeft;
var photoTop;
var cropInverseAspectRatio;
var cropped = false;
var minWidth;
var maxWidth;
var minHeight;
var maxHeight;

var photo;
var cropper;
var photoMinX;
var photoMinY;
var photoMaxX;
var photoMaxY;
var divWidth;
var divHeight;
var cropXField;
var cropYField;
var cropWidthField;
var cropHeightField;
var cropWidth;
var cropHeight;
var photoScale;
var cropperLeft;
var cropperTop;
var cropperWidth;
var cropperHeight;
var controlDiv;

var imageNames;
var imageFiles;

var downloadBlobURL = true;      // if true, create a blob: URL / if false, create a data: URL
var downloadLink;                // the HTML <a> element for the Save link
var downloadLinkReady = false;   // only used if downloadBlobURL is true
var downloadURL = null;          // only used if downloadBlobURL is true
var downloadQuality = 0.92;
var downloadType = "image/jpeg";

function releaseElement()
{
	document.onmousemove = null;
	document.onmouseup = null;
}
function photoDrag(event)
{
	var x = startX + event.clientX;
	var y = startY + event.clientY;

	var scaleX = divWidth / cropWidth;
	var scaleY = divHeight / cropHeight;

	var dW = (originalWidth - cropWidth) * scaleX;
	var dH = (originalHeight - cropHeight) * scaleY;

	var photoMinLeft = -dW;
	var photoMaxLeft = 0;
	var photoMinTop = -dH;
	var photoMaxTop = 0;

	if (rotateAngle === 90) {
		photoMinLeft = 0;
		photoMaxLeft = dH;
		photoMinTop = -dW;
		photoMaxTop = 0;
	} else if (rotateAngle === 180) {
		photoMinLeft = 0;
		photoMaxLeft = dW;
		photoMinTop = 0;
		photoMaxTop = dH;
	} else if (rotateAngle === 270) {
		photoMinLeft = -dH;
		photoMaxLeft = 0;
		photoMinTop = 0;
		photoMaxTop = dW;
	}

	if (x > photoMaxLeft) x = photoMaxLeft;
	else if (x < photoMinLeft) x = photoMinLeft;
	if (y > photoMaxTop) y = photoMaxTop;
	else if (y < photoMinTop) y = photoMinTop;

	photo.style.left = x + 'px';
	photo.style.top = y + 'px';

	var x2 = Math.round(x / scaleX);
	var y2 = Math.round(y / scaleY);
	if (rotateAngle === 0) {
		photoLeft = x;
		photoTop = y;
		cropXField.value = -x2;
		cropYField.value = -y2;
	} else if (rotateAngle === 90) {
		photoLeft = y;
		photoTop = -x;
		cropXField.value = -y2;
		cropYField.value = x2;
	} else if (rotateAngle === 180) {
		photoLeft = -x;
		photoTop = -y;
		cropXField.value = x2;
		cropYField.value = y2;
	} else if (rotateAngle === 270) {
		photoLeft = -y;
		photoTop = x;
		cropXField.value = y2;
		cropYField.value = -x2;
	}

	return false;
}
function startPhotoDrag(event)
{
	startX = photo.offsetLeft - event.clientX;
	startY = photo.offsetTop - event.clientY;
	document.onmousemove = photoDrag;
	document.onmouseup = releaseElement;
	return false;
}
function cropperDrag(event)
{
	var x = startX + event.clientX;
	var y = startY + event.clientY;
	if (x < photoMinX) x = photoMinX;
	if (y < photoMinY) y = photoMinY;
	var x2 = Math.round((x - photoMinX) * photoScale);
	var y2 = Math.round((y - photoMinY) * photoScale);
	var dW = originalWidth - cropWidth;
	var dH = originalHeight - cropHeight;
	if (rotateAngle === 0) {
		if (x2 > dW) x2 = dW;
		if (y2 > dH) y2 = dH;
		cropXField.value = x2;
		cropYField.value = y2;
	} else if (rotateAngle === 90) {
		if (x2 > dH) x2 = dH;
		if (y2 > dW) y2 = dW;
		cropXField.value = y2;
		cropYField.value = dH - x2;
	} else if (rotateAngle === 180) {
		if (x2 > dW) x2 = dW;
		if (y2 > dH) y2 = dH;
		cropXField.value = dW - x2;
		cropYField.value = dH - y2;
	} else if (rotateAngle === 270) {
		if (x2 > dH) x2 = dH;
		if (y2 > dW) y2 = dW;
		cropXField.value = dW - y2;
		cropYField.value = x2;
	}
	if (x + cropperWidth > photoMaxX) x = photoMaxX - cropperWidth;
	if (y + cropperHeight > photoMaxY) y = photoMaxY - cropperHeight;
	cropper.style.left = (cropperLeft = x) + 'px';
	cropper.style.top = (cropperTop = y) + 'px';
	return false;
}
function startCropperDrag(event)
{
	startX = cropperLeft - event.clientX;
	startY = cropperTop - event.clientY;
	document.onmousemove = cropperDrag;
	document.onmouseup = releaseElement;
	return false;
}
function dragResize(event)
{
	var dX = (event.clientX - startX) * multiplyX;
	var dY = (event.clientY - startY) * multiplyY;
	var absdX = Math.abs(dX);
	var absdY = Math.abs(dY);
	if (absdX < 2 && absdY < 2)
		return false;
	if (dX * dY <= 0)
	{
		startX = event.clientX;
		startY = event.clientY;
		return false;
	}

	var delta;
	var aspect;
	var cropDimension;
	var setCropDimension;

	if (absdX > absdY) {
		delta = dX;
		setCropDimension = (rotateAngle === 0 || rotateAngle === 180) ? setCropWidth : setCropHeight;
	} else {
		delta = dY;
		setCropDimension = (rotateAngle === 0 || rotateAngle === 180) ? setCropHeight : setCropWidth;
	}

	if (setCropDimension === setCropWidth) {
		aspect = aspectX;
		cropDimension = cropWidth;
	} else {
		aspect = aspectY;
		cropDimension = cropHeight;
	}

	delta = Math.trunc(2 * delta * photoScale / aspect) * aspect;
	if (delta === 0)
		return false;

	setCropDimension(cropDimension - delta);
	startX = event.clientX;
	startY = event.clientY;
	return false;
}
function startDragResize(event)
{
	event.cancelBubble = true;
	if (event.stopPropagation) event.stopPropagation();
	startX = event.clientX;
	startY = event.clientY;
	document.onmousemove = dragResize;
	document.onmouseup = releaseElement;
	return false;
}
function startDragResizeNW(event)
{
	multiplyX = 1;
	multiplyY = 1;
	return startDragResize(event);
}
function startDragResizeNE(event)
{
	multiplyX = -1;
	multiplyY = 1;
	return startDragResize(event);
}
function startDragResizeSE(event)
{
	multiplyX = -1;
	multiplyY = -1;
	return startDragResize(event);
}
function startDragResizeSW(event)
{
	multiplyX = 1;
	multiplyY = -1;
	return startDragResize(event);
}
function greatestCommonDivisor(a, b)
{
	while (b !== 0)
	{
		var remainder = a % b;
		a = b;
		b = remainder;
	}
	return a;
}
function setDisplayArea()
{
	var width = 900;
	var height = 600;

	if (originalWidth > originalHeight && width > height ||
		originalWidth < originalHeight && width < height)
	{
		divWidth = width;
		divHeight = height;
	} else {
		divWidth = height;
		divHeight = width;
	}

	if (divWidth > originalWidth)
		divWidth = originalWidth;
	if (divHeight > originalHeight)
		divHeight = originalHeight;

	if (divWidth / divHeight != originalWidth / originalHeight)
	{
		var m = Math.floor(divWidth / aspectX);
		if (m === 0)
			m = 1;
		divWidth = m * aspectX;
		divHeight = m * aspectY;
	}

	document.getElementById("divWidth").value = divWidth;
	document.getElementById("divHeight").value = divHeight;
	document.getElementById("aspectRatio").firstChild.nodeValue = '(' + aspectX + ':' + aspectY + ')';

	photoLeft = 0;
	photoTop = 0;
	photo.style.left = '0px';
	photo.style.top = '0px';
	photo.style.width = divWidth + 'px';
	photo.style.height = divHeight + 'px';
	photo.style.webkitTransform = null;
	photo.style.transform = null;
	photo.style.cursor = 'default';
	photo.onmousedown = preventDefault;

	var photoDiv = document.getElementById("photoDiv");
	photoDiv.style.width = divWidth + 'px';
	photoDiv.style.height = divHeight + 'px';
	photoMinX = photoDiv.offsetLeft + 4;
	photoMinY = photoDiv.offsetTop + 4;
	photoMaxX = photoDiv.offsetLeft + photoDiv.offsetWidth - 4;
	photoMaxY = photoDiv.offsetTop + photoDiv.offsetHeight - 4;

	photoScale = originalWidth / divWidth;
	rotateAngle = 0;
	minWidth = divWidth;
	maxWidth = originalWidth;
	minHeight = divHeight;
	maxHeight = originalHeight;
}
function init()
{
	var gcd = greatestCommonDivisor(originalWidth, originalHeight);
	aspectX = originalWidth / gcd;
	aspectY = originalHeight / gcd;
	cropInverseAspectRatio = false;

	setDisplayArea();
	setInverseAspectRatioAbility();

	cropWidthField = document.getElementById("cropWidthField");
	cropHeightField = document.getElementById("cropHeightField");
	cropWidthField.value = cropWidth = Math.max(divWidth, originalWidth / 2);
	cropHeightField.value = cropHeight = Math.max(divHeight, originalHeight / 2);

	cropXField = document.getElementById("cropXField");
	cropYField = document.getElementById("cropYField");
	cropXField.value = (originalWidth - cropWidth) / 2;
	cropYField.value = (originalHeight - cropHeight) / 2;

	setCropperXY();
	cropperWidth = cropWidth / photoScale;
	cropperHeight = cropHeight / photoScale;
	cropper.style.width = (cropperWidth - 4) + 'px';
	cropper.style.height = (cropperHeight - 4) + 'px';
	cropper.onmousedown = startCropperDrag;

	document.getElementById("resizeNW").onmousedown = startDragResizeNW;
	document.getElementById("resizeNE").onmousedown = startDragResizeNE;
	document.getElementById("resizeSW").onmousedown = startDragResizeSW;
	document.getElementById("resizeSE").onmousedown = startDragResizeSE;

	if (document.getElementById("inverseAspectRatioCheckbox").checked)
		toggleInverseAspectRatio();
}
function setCropWidthAndHeight(width, height)
{
	var x = +cropXField.value + Math.floor(cropWidth / 2 - width / 2);
	var y = +cropYField.value + Math.floor(cropHeight / 2 - height / 2);

	if (x + width > originalWidth)
		x = originalWidth - width;
	else if (x < 0)
		x = 0;
	if (y + height > originalHeight)
		y = originalHeight - height;
	else if (y < 0)
		y = 0;

	cropXField.value = x;
	cropYField.value = y;
	cropWidthField.value = width;
	cropHeightField.value = height;
	cropWidth = width;
	cropHeight = height;

	width = Math.round(width / photoScale);
	height = Math.round(height / photoScale);
	if (rotateAngle === 0 || rotateAngle === 180) {
		cropperWidth = width;
		cropperHeight = height;
	} else {
		cropperWidth = height;
		cropperHeight = width;
	}
	cropper.style.width = (cropperWidth - 4) + 'px';
	cropper.style.height = (cropperHeight - 4) + 'px';
	setCropperXY();
}
function setCropWidth(width)
{
	if (width > maxWidth)
		width = maxWidth;
	else if (width < minWidth || isNaN(width))
		width = minWidth;

	width -= width % aspectX;
	setCropWidthAndHeight(width, width / aspectX * aspectY);
}
function setCropHeight(height)
{
	if (height > maxHeight)
		height = maxHeight;
	else if (height < minHeight || isNaN(height))
		height = minHeight;

	height -= height % aspectY;
	setCropWidthAndHeight(height / aspectY * aspectX, height);
}
function changeCropWidth()
{
	setCropWidth(+cropWidthField.value);
	if (cropped) crop();
}
function changeCropHeight()
{
	setCropHeight(+cropHeightField.value);
	if (cropped) crop();
}
function changeCropX()
{
	var x = +cropXField.value;

	if (x + cropWidth > originalWidth)
		x = originalWidth - cropWidth;
	else if (x < 0 || isNaN(x))
		x = 0;

	cropXField.value = x;
	setCropperXY();
	if (cropped) {
		photoLeft = -x * divWidth / cropWidth;
		if (rotateAngle === 0)
			photo.style.left = photoLeft + 'px';
		else if (rotateAngle === 90)
			photo.style.top = photoLeft + 'px';
		else if (rotateAngle === 180)
			photo.style.left = -photoLeft + 'px';
		else if (rotateAngle === 270)
			photo.style.top = -photoLeft + 'px';
		setSpecParam();
	}
}
function changeCropY()
{
	var y = +cropYField.value;

	if (y + cropHeight > originalHeight)
		y = originalHeight - cropHeight;
	else if (y < 0 || isNaN(y))
		y = 0;

	cropYField.value = y;
	setCropperXY();
	if (cropped) {
		photoTop = -y * divHeight / cropHeight;
		if (rotateAngle === 0)
			photo.style.top = photoTop + 'px';
		else if (rotateAngle === 90)
			photo.style.left = -photoTop + 'px';
		else if (rotateAngle === 180)
			photo.style.top = -photoTop + 'px';
		else if (rotateAngle === 270)
			photo.style.left = photoTop + 'px';
		setSpecParam();
	}
}
function setSpecParam()
{
	document.getElementById("specParam").value = "('"
		+ document.getElementById("fileNameField").value + "', '"
		+ cropWidth + "x" + cropHeight + "+"
		+ cropXField.value + "+" + cropYField.value + "')";
}
function crop()
{
	if (cropInverseAspectRatio && !cropped) {
		turnPhotoDiv();
		var width = divWidth;
		var height = divHeight;
		divWidth = height;
		divHeight = width;
	}

	var scaleX = divWidth / cropWidth;
	var scaleY = divHeight / cropHeight;

	photoLeft = -cropXField.value * scaleX;
	photoTop = -cropYField.value * scaleY;
	photo.style.width = (originalWidth * scaleX) + 'px';
	photo.style.height = (originalHeight * scaleY) + 'px';

	transformPhoto();
	setSpecParam();

	cropped = true;
	cropper.style.display = 'none';
	photo.onmousedown = startPhotoDrag;
	photo.style.cursor = 'move';
}
function undo()
{
	if (cropInverseAspectRatio && cropped) {
		turnPhotoDiv();
		var width = divWidth;
		var height = divHeight;
		divWidth = height;
		divHeight = width;
	}

	photoLeft = 0;
	photoTop = 0;
	photo.style.width = divWidth + 'px';
	photo.style.height = divHeight + 'px';

	transformPhoto();
	setCropperXY();

	photo.onmousedown = preventDefault;
	photo.style.cursor = 'default';
	cropper.style.display = 'block';
	cropped = false;
}
function transformPhoto()
{
	var transform = null;
	var delta = (photo.offsetWidth - photo.offsetHeight) / 2;
	var dX = 0;
	var dY = 0;
	var left = photoLeft;
	var top = photoTop;

	if (rotateAngle === 90) {
		dX = delta;
		dY = delta + photo.offsetHeight - divHeight;
		left = -photoTop;
		top = photoLeft;
	} else if (rotateAngle === 180) {
		dX = photo.offsetWidth - divWidth;
		dY = photo.offsetHeight - divHeight;
		left = -photoLeft;
		top = -photoTop;
	} else if (rotateAngle === 270) {
		dX = -delta + photo.offsetWidth - divWidth;
		dY = -delta;
		left = photoTop;
		top = -photoLeft;
	}

	if (rotateAngle !== 0 || dX !== 0 || dY !== 0) {
		transform = "rotate(" + rotateAngle + "deg)";
		transform += " translate(" + dX + "px," + dY + "px)";
	}
	photo.style.webkitTransform = transform;
	photo.style.transform = transform;
	photo.style.left = left + 'px';
	photo.style.top = top + 'px';
}
function setCropperXY()
{
	var x = Math.round(cropXField.value / photoScale);
	var y = Math.round(cropYField.value / photoScale);
	if (rotateAngle === 0) {
		cropperLeft = photoMinX + x;
		cropperTop = photoMinY + y;
	} else if (rotateAngle === 90) {
		cropperLeft = photoMaxX - y - cropperWidth;
		cropperTop = photoMinY + x;
	} else if (rotateAngle === 180) {
		cropperLeft = photoMaxX - x - cropperWidth;
		cropperTop = photoMaxY - y - cropperHeight;
	} else if (rotateAngle === 270) {
		cropperLeft = photoMinX + y;
		cropperTop = photoMaxY - x - cropperHeight;
	}
	cropper.style.left = cropperLeft + 'px';
	cropper.style.top = cropperTop + 'px';
}
function turnPhotoDiv()
{
	var photoDiv = document.getElementById("photoDiv");
	var width = photoDiv.offsetWidth - 8;
	var height = photoDiv.offsetHeight - 8;
	photoDiv.style.width = height + 'px';
	photoDiv.style.height = width + 'px';
	photoMinX = photoDiv.offsetLeft + 4;
	photoMinY = photoDiv.offsetTop + 4;
	photoMaxX = photoDiv.offsetLeft + photoDiv.offsetWidth - 4;
	photoMaxY = photoDiv.offsetTop + photoDiv.offsetHeight - 4;
}
function rotatePhoto(angle)
{
	rotateAngle = (rotateAngle + angle) % 360;
	transformPhoto();
	var oldCropperLeft = cropperLeft - photoMinX;
	var oldCropperTop = cropperTop - photoMinY;
	if (angle === 90 || angle === 270) {
		turnPhotoDiv();
		var width = cropperWidth;
		var height = cropperHeight;
		cropperWidth = height;
		cropperHeight = width;
		cropper.style.width = (cropperWidth - 4) + 'px';
		cropper.style.height = (cropperHeight - 4) + 'px';
	}
	if (angle === 90) {
		cropperLeft = photoMaxX - oldCropperTop - cropperWidth;
		cropperTop = photoMinY + oldCropperLeft;
	} else if (angle === 180) {
		cropperLeft = photoMaxX - oldCropperLeft - cropperWidth;
		cropperTop = photoMaxY - oldCropperTop - cropperHeight;
	} else if (angle === 270) {
		cropperLeft = photoMinX + oldCropperTop;
		cropperTop = photoMaxY - oldCropperLeft - cropperHeight;
	}
	cropper.style.left = cropperLeft + 'px';
	cropper.style.top = cropperTop + 'px';
}
function setInverseAspectRatioAbility()
{
	var checkbox = document.getElementById("inverseAspectRatioCheckbox");

	if (originalWidth > originalHeight) {
		if (divWidth > originalHeight)
			checkbox.disabled = true;
	} else {
		if (divHeight > originalWidth)
			checkbox.disabled = true;
	}
	if (checkbox.disabled)
		checkbox.checked = false;
}
function toggleInverseAspectRatio()
{
	cropInverseAspectRatio = !cropInverseAspectRatio;

	if (cropInverseAspectRatio) {
		minWidth = divHeight;
		minHeight = divWidth;

		if (originalWidth > originalHeight) {
			maxWidth = Math.floor(originalHeight / aspectX * aspectY);
			maxHeight = originalHeight;
		} else {
			maxWidth = originalWidth;
			maxHeight = Math.floor(originalWidth / aspectY * aspectX);
		}
	} else {
		minWidth = divWidth;
		maxWidth = originalWidth;

		minHeight = divHeight;
		maxHeight = originalHeight;
	}

	var x = aspectX;
	var y = aspectY;
	aspectX = y;
	aspectY = x;

	if (originalWidth > originalHeight)
		setCropHeight(cropWidth);
	else
		setCropWidth(cropHeight);

	if (cropped) {
		turnPhotoDiv();
		var width = divWidth;
		var height = divHeight;
		divWidth = height;
		divHeight = width;
		crop();
	}
}
function controlDivDrag(event)
{
	controlDiv.style.left = (startX + event.clientX) + 'px';
	controlDiv.style.top = (startY + event.clientY) + 'px';
	return false;
}
function startControlDivDrag(event)
{
	if (event.target instanceof HTMLInputElement ||
		event.target instanceof HTMLSelectElement) return true;
	startX = controlDiv.offsetLeft - event.clientX;
	startY = controlDiv.offsetTop - event.clientY;
	document.onmousemove = controlDivDrag;
	document.onmouseup = releaseElement;
	return false;
}
function preventDefault(event)
{
	if (event.preventDefault) event.preventDefault();
}
function showLoading(fileName)
{
	cropper.style.cursor = "wait";
	document.body.style.cursor = "wait";

	document.getElementById("spinDisc").style.animationPlayState = "running";

	var statusDiv = document.getElementById("statusDiv");
	statusDiv.firstChild.firstChild.nodeValue = "Loading " + fileName;
	statusDiv.style.display = "block";

	var displayWidth = document.documentElement.clientWidth;
	var displayHeight = document.documentElement.clientHeight;

	var left = Math.round((displayWidth - statusDiv.clientWidth) / 2);
	var top = Math.round((displayHeight - statusDiv.clientHeight) / 2);

	statusDiv.style.left = left + "px";
	statusDiv.style.top = top + "px";
}
function imageLoaded()
{
	if (cropped) undo();

	photo.src = this.src;
	originalWidth = this.width;
	originalHeight = this.height;

	if (imageFiles !== undefined)
		URL.revokeObjectURL(this.src);

	init();

	cropper.style.cursor = "move";
	document.body.style.cursor = "default";
	document.getElementById("statusDiv").style.display = "none";
	document.getElementById("spinDisc").style.animationPlayState = "paused";
}
function loadImage()
{
	var prevButton = document.getElementById("prevButton");
	var nextButton = document.getElementById("nextButton");
	if (imageNames === undefined)
	{
		prevButton.disabled = true;
		nextButton.disabled = true;
		downloadLink.style.display = "none";
		return;
	}
	var fileNameField = document.getElementById("fileNameField");
	if (fileNameField.options.length === 0)
	{
		for (var i = 0; i < imageNames.length; ++i)
			fileNameField.options[i] = new Option(imageNames[i], imageNames[i], false, false);
		fileNameField.selectedIndex = 0;
	}
	var selectedIndex = fileNameField.selectedIndex;
	prevButton.disabled = (selectedIndex === 0);
	nextButton.disabled = (selectedIndex === fileNameField.options.length - 1);

	downloadLink.download = imageNames[selectedIndex];
	downloadLink.style.display = "inline";

	showLoading(imageNames[selectedIndex]);

	var imageObject = new Image();
	imageObject.onload = imageLoaded;
	if (imageFiles === undefined)
		imageObject.src = "originals/" + imageNames[selectedIndex];
	else
		imageObject.src = URL.createObjectURL(imageFiles[selectedIndex]);
}
function prevImage()
{
	var fileNameField = document.getElementById("fileNameField");
	if (fileNameField.selectedIndex > 0)
		--fileNameField.selectedIndex;
	loadImage();
}
function nextImage()
{
	var fileNameField = document.getElementById("fileNameField");
	if (fileNameField.selectedIndex < fileNameField.options.length - 1)
		++fileNameField.selectedIndex;
	loadImage();
}
function applyFullFilterMatrix(d, a0, a1, a2, a3)
{
	var dLen = d.length;
	for (var i = 0; i < dLen; i += 4)
	{
		var r = d[i];
		var g = d[i + 1];
		var b = d[i + 2];
		var a = d[i + 3];

		d[i]     = a0[0] * r + a0[1] * g + a0[2] * b + a0[3] * a + a0[4] * 255;
		d[i + 1] = a1[0] * r + a1[1] * g + a1[2] * b + a1[3] * a + a1[4] * 255;
		d[i + 2] = a2[0] * r + a2[1] * g + a2[2] * b + a2[3] * a + a2[4] * 255;
		d[i + 3] = a3[0] * r + a3[1] * g + a3[2] * b + a3[3] * a + a3[4] * 255;
	}
}
function applyFilterMatrix(d, a0, a1, a2)
{
	var dLen = d.length;
	for (var i = 0; i < dLen; i += 4)
	{
		var r = d[i];
		var g = d[i + 1];
		var b = d[i + 2];

		d[i]     = a0[0] * r + a0[1] * g + a0[2] * b;
		d[i + 1] = a1[0] * r + a1[1] * g + a1[2] * b;
		d[i + 2] = a2[0] * r + a2[1] * g + a2[2] * b;
	}
}
function applyBrightnessFilter(d, value)
{
	var dLen = d.length;
	for (var i = 0; i < dLen; i += 4)
	{
		d[i]     *= value;
		d[i + 1] *= value;
		d[i + 2] *= value;
	}
}
function applyContrastFilter(d, value)
{
	var intercept = 255 * (0.5 - 0.5 * value);

	var dLen = d.length;
	for (var i = 0; i < dLen; i += 4)
	{
		d[i]     = d[i]     * value + intercept;
		d[i + 1] = d[i + 1] * value + intercept;
		d[i + 2] = d[i + 2] * value + intercept;
	}
}
function applyGrayscaleFilter(d, value)
{
	var s = 1 - value;

	applyFilterMatrix(d,
		[0.2126 + 0.7874*s, 0.7152 - 0.7152*s, 0.0722 - 0.0722*s],
		[0.2126 - 0.2126*s, 0.7152 + 0.2848*s, 0.0722 - 0.0722*s],
		[0.2126 - 0.2126*s, 0.7152 - 0.7152*s, 0.0722 + 0.9278*s]);
}
function applyHueRotateFilter(d, value)
{
	value *= Math.PI / 180; // Convert degrees to radians

	var c = Math.cos(value);
	var s = Math.sin(value);

	applyFilterMatrix(d,
		[0.213 + 0.787*c - 0.213*s, 0.715 - 0.715*c - 0.715*s, 0.072 - 0.072*c + 0.928*s],
		[0.213 - 0.213*c + 0.143*s, 0.715 + 0.285*c + 0.140*s, 0.072 - 0.072*c - 0.283*s],
		[0.213 - 0.213*c - 0.787*s, 0.715 - 0.715*c + 0.715*s, 0.072 + 0.928*c + 0.072*s]);
}
function applyInvertFilter(d, value)
{
	var m = 1.0 - value - value;
	var c = 255 * value;

	var dLen = d.length;
	for (var i = 0; i < dLen; i += 4)
	{
		d[i]     = d[i]     * m + c;
		d[i + 1] = d[i + 1] * m + c;
		d[i + 2] = d[i + 2] * m + c;
	}
}
function applySaturateFilter(d, value)
{
	var s = value;

	applyFilterMatrix(d,
		[0.213 + 0.787*s, 0.715 - 0.715*s, 0.072 - 0.072*s],
		[0.213 - 0.213*s, 0.715 + 0.285*s, 0.072 - 0.072*s],
		[0.213 - 0.213*s, 0.715 - 0.715*s, 0.072 + 0.928*s]);
}
function applySepiaFilter(d, value)
{
	var s = 1 - value;

	applyFilterMatrix(d,
		[0.393 + 0.607*s, 0.769 - 0.769*s, 0.189 - 0.189*s],
		[0.349 - 0.349*s, 0.686 + 0.314*s, 0.168 - 0.168*s],
		[0.272 - 0.272*s, 0.534 - 0.534*s, 0.131 + 0.869*s]);
}
function saveImage(event)
{
	if (downloadBlobURL) {
		if (downloadLinkReady) {
			downloadLinkReady = false;
			return;
		}
		if (downloadURL !== null)
			URL.revokeObjectURL(downloadURL);
	}

	var canvas = document.getElementById("canvas");
	if (rotateAngle === 0 || rotateAngle === 180) {
		canvas.width = divWidth;
		canvas.height = divHeight;
	} else {
		canvas.width = divHeight;
		canvas.height = divWidth;
	}
//	canvas.style.width = canvas.width + "px";
//	canvas.style.height = canvas.height + "px";

	var context = canvas.getContext("2d");

	if (rotateAngle === 0)
		context.setTransform(1, 0, 0, 1, 0, 0);
	else if (rotateAngle === 90)
		context.setTransform(0, 1, -1, 0, canvas.width, 0);
	else if (rotateAngle === 180)
		context.setTransform(-1, 0, 0, -1, canvas.width, canvas.height);
	else if (rotateAngle === 270)
		context.setTransform(0, -1, 1, 0, 0, canvas.height);

	if (cropped)
		context.drawImage(photo, +cropXField.value, +cropYField.value,
			cropWidth, cropHeight, 0, 0, divWidth, divHeight);
	else
		context.drawImage(photo, 0, 0, divWidth, divHeight);

	var imageData = context.getImageData(0, 0, canvas.width, canvas.height);

	for (var filter of filters)
	{
		var option = filterOptions[filter.selectElement.selectedIndex];

		if (option.name === "brightness")
			applyBrightnessFilter(imageData.data, filter.value / 100);
		else if (option.name === "contrast")
			applyContrastFilter(imageData.data, filter.value / 100);
		else if (option.name === "grayscale")
			applyGrayscaleFilter(imageData.data, filter.value / 100);
		else if (option.name === "hue-rotate")
			applyHueRotateFilter(imageData.data, filter.value);
		else if (option.name === "invert")
			applyInvertFilter(imageData.data, filter.value / 100);
		else if (option.name === "saturate")
			applySaturateFilter(imageData.data, filter.value / 100);
		else if (option.name === "sepia")
			applySepiaFilter(imageData.data, filter.value / 100);
	}

	context.putImageData(imageData, 0, 0);

	if (downloadBlobURL && canvas.toBlob === undefined) // for Chrome and Safari
		downloadBlobURL = false;

	if (downloadBlobURL) {
		event.preventDefault();
		canvas.toBlob(function(blob) {
			downloadLink.href = downloadURL = URL.createObjectURL(blob);
			downloadLinkReady = true;
			downloadLink.click();
		}, downloadType, downloadQuality);
	} else {
		downloadLink.href = canvas.toDataURL(downloadType, downloadQuality);
	}
}
function FilterOption(name, unit, defaultValue, minValue, maxValue)
{
	this.name = name;
	this.unit = unit;
	this.defaultValue = defaultValue;
	this.minValue = minValue;
	this.maxValue = maxValue;
}
var filterOptions = [
	new FilterOption('blur',       'px',    0, 0,   20),
	new FilterOption('brightness', '%',   100, 0, 2000),
	new FilterOption('contrast',   '%',   100, 0,  800),
	new FilterOption('grayscale',  '%',     0, 0,  100),
	new FilterOption('hue-rotate', 'deg',   0, 0,  360),
	new FilterOption('invert',     '%',     0, 0,  100),
	new FilterOption('saturate',   '%',   100, 0, 1000),
	new FilterOption('sepia',      '%',     0, 0,  100)
];
function Filter(selectElement, sliderElement, inputElement, textNode)
{
	this.selectElement = selectElement;
	this.sliderElement = sliderElement;
	this.inputElement = inputElement;
	this.textNode = textNode;
	this.value = inputElement.value;
	this.tableRow = selectElement.parentNode.parentNode;
}
var filters = [];

function applyFilters()
{
	var filterList = [];
	for (var filter of filters)
	{
		var option = filterOptions[filter.selectElement.selectedIndex];

		filterList.push(option.name + '(' + filter.value + option.unit + ')');
	}
	var filterStyle = filterList.join(' ');
	photo.style.webkitFilter = filterStyle;
	photo.style.filter = filterStyle;
}
function changeFilterName(event)
{
	var selectElement = event.currentTarget;
	var tableRow = selectElement.parentNode.parentNode;

	var filter = filters[parseInt(tableRow.id.substr(9), 10)];
	var option = filterOptions[selectElement.selectedIndex];

	filter.sliderElement.min = option.minValue;
	filter.sliderElement.max = option.maxValue;

	filter.value = option.defaultValue;
	filter.sliderElement.value = option.defaultValue;
	filter.inputElement.value = option.defaultValue;
	filter.textNode.nodeValue = option.unit;

	applyFilters();
}
function changeFilterValue(event)
{
	var inputElement = event.currentTarget;
	var tableRow = inputElement.parentNode.parentNode;

	var filter = filters[parseInt(tableRow.id.substr(9), 10)];
	var option = filterOptions[filter.selectElement.selectedIndex];

	var value = parseInt(inputElement.value, 10);

	if (isNaN(value) || value != inputElement.value || value < option.minValue || value > option.maxValue) {
		inputElement.value = filter.value;
	} else {
		filter.value = inputElement.value;
		if (inputElement === filter.sliderElement)
			filter.inputElement.value = filter.value;
		else
			filter.sliderElement.value = filter.value;
		applyFilters();
	}
}
function addFilterRowBefore(event)
{
	var span = event.currentTarget;
	var tableRow = span.parentNode.parentNode;
	var rowNumber = parseInt(tableRow.id.substr(9), 10); // e.g. filterRow0

	if (rowNumber === 0) // Remove +
	{
		var firstCell = tableRow.firstChild;
		firstCell.replaceChild(createEmptyText(), firstCell.firstChild);
	}
	if (filters.length === 1) // Add X
	{
		var lastCell = tableRow.lastChild;
		lastCell.replaceChild(createXMarkAfter(), lastCell.firstChild);
	}

	for (var i = filters.length - 1; i >= rowNumber; --i)
	{
		filters[i].tableRow.id = 'filterRow' + (i + 1);
		filters[i + 1] = filters[i];
	}

	var newRow = createFilterRow(rowNumber);
	tableRow.parentNode.insertBefore(newRow, tableRow);
}
function addFilterRowAfter(event)
{
	var span = event.currentTarget;
	var tableRow = span.parentNode.parentNode;
	var rowNumber = parseInt(tableRow.id.substr(9), 10); // e.g. filterRow0

	if (filters.length === 1) // Add X
	{
		var lastCell = tableRow.lastChild;
		lastCell.replaceChild(createXMarkAfter(), lastCell.firstChild);
	}

	for (var i = filters.length - 1; i > rowNumber; --i)
	{
		filters[i].tableRow.id = 'filterRow' + (i + 1);
		filters[i + 1] = filters[i];
	}

	var newRow = createFilterRow(rowNumber + 1);
	tableRow.parentNode.insertBefore(newRow, tableRow.nextSibling);
}
function removeFilterRow(event)
{
	var span = event.currentTarget;
	var tableRow = span.parentNode.parentNode;
	var rowNumber = parseInt(tableRow.id.substr(9), 10); // e.g. filterRow0

	tableRow.parentNode.removeChild(tableRow);

	for (var i = rowNumber; i < filters.length - 1; ++i)
	{
		filters[i] = filters[i + 1];
		filters[i].tableRow.id = 'filterRow' + i;
	}

	filters.length -= 1;

	if (filters.length === 1) // Remove X
	{
		var lastCell = filters[0].tableRow.lastChild;
		lastCell.replaceChild(createEmptyText(), lastCell.firstChild);
	}
	if (rowNumber === 0) // Add +
	{
		var firstCell = filters[0].tableRow.firstChild;
		firstCell.replaceChild(createPlusBefore(), firstCell.firstChild);
	}

	applyFilters();
}
function createClickableText(text, clickHandler)
{
	var span = document.createElement('SPAN');
	span.appendChild(document.createTextNode(text));
	span.className = 'clickable';
	span.addEventListener('click', clickHandler, false);
	return span;
}
function createPlusBefore()
{
	return createClickableText('+', addFilterRowBefore);
}
function createPlusAfter()
{
	return createClickableText('+', addFilterRowAfter);
}
function createXMarkAfter()
{
	return createClickableText('\u00D7', removeFilterRow);
}
function createEmptyText()
{
	return document.createTextNode('\u00A0');
}
function addFilterCell(tableRow, cellChild)
{
	var tableCell = document.createElement('TD');
	tableCell.appendChild(cellChild);
	tableRow.appendChild(tableCell);
}
function createFilterRow(rowNumber)
{
	var tableRow = document.createElement('TR');
	tableRow.id = 'filterRow' + rowNumber;

	if (rowNumber === 0)
		addFilterCell(tableRow, createPlusBefore());
	else
		addFilterCell(tableRow, createEmptyText());

	var selectElement = document.createElement('SELECT');
	selectElement.addEventListener('change', changeFilterName, false);

	for (var option of filterOptions)
		selectElement.add(new Option(option.name, option.name, false, false));

	option = filterOptions[selectElement.selectedIndex = 2];

	var sliderElement = document.createElement('INPUT');
	sliderElement.type = 'range';
	sliderElement.min = option.minValue;
	sliderElement.max = option.maxValue;
	sliderElement.value = option.defaultValue;
	sliderElement.addEventListener('change', changeFilterValue, false);

	var inputElement = document.createElement('INPUT');
	inputElement.type = 'text';
	inputElement.size = 4;
	inputElement.maxLength = 4;
	inputElement.value = option.defaultValue;
	inputElement.addEventListener('change', changeFilterValue, false);

	var textNode = document.createTextNode(option.unit);

	var tableCell = document.createElement('TD');
	tableCell.appendChild(selectElement);
	tableCell.appendChild(sliderElement);
	tableCell.appendChild(inputElement);
	tableCell.appendChild(textNode);
	tableRow.appendChild(tableCell);

	filters[rowNumber] = new Filter(selectElement, sliderElement, inputElement, textNode);

	addFilterCell(tableRow, createPlusAfter());
	if (filters.length === 1)
		addFilterCell(tableRow, createEmptyText());
	else
		addFilterCell(tableRow, createXMarkAfter());

	return tableRow;
}
function createFilterDiv()
{
	var tableRow = createFilterRow(0);

	var table = document.createElement('TABLE');
	table.appendChild(tableRow);

	var filterDiv = document.getElementById('filterDiv');
	filterDiv.appendChild(table);
}
function toggleShowFilters(event)
{
	event.preventDefault();

	var filterDiv = document.getElementById('filterDiv');
	var toggleFiltersLink = document.getElementById('toggleFiltersLink').firstChild;

	if (filterDiv.style.display === 'none') {
		filterDiv.style.display = 'block';
		toggleFiltersLink.nodeValue = 'Hide Filters';
	} else {
		filterDiv.style.display = 'none';
		toggleFiltersLink.nodeValue = 'Show Filters';
	}
}
function browseFiles(event)
{
	event.preventDefault();
	document.getElementById("fileBrowser").click();
}
function loadFiles()
{
	var files = document.getElementById("fileBrowser").files;

	var newImageNames = [];
	var newImageFiles = [];

	for (var i = 0; i < files.length; ++i)
		if (files[i].type.substr(0, 6) === 'image/')
		{
			newImageNames.push(files[i].name);
			newImageFiles.push(files[i]);
		}

	if (newImageNames.length === 0) return;

	imageNames = newImageNames;
	imageFiles = newImageFiles;

	var fileNameField = document.getElementById("fileNameField");
	fileNameField.options.length = 0;
	fileNameField.selectedIndex = -1;

	loadImage();
}
function bodyLoaded()
{
	photo = document.getElementById("photo");
	cropper = document.getElementById("cropper");

	var photoDiv = document.getElementById("photoDiv");
	cropper.style.left = (photoDiv.offsetLeft + 4) + 'px';
	cropper.style.top = (photoDiv.offsetTop + 4) + 'px';

	controlDiv = document.getElementById("controlDiv");
	controlDiv.onmousedown = startControlDivDrag;

	// Hack for Mozilla to clear any previously selected files
	document.getElementById("fileBrowser").value = "";
	document.getElementById("specParam").value = "";

	downloadLink = document.getElementById("downloadLink");
	downloadLink.addEventListener("click", saveImage, false);

	createFilterDiv();
	document.getElementById("toggleFiltersLink").addEventListener("click", toggleShowFilters, false);
	document.getElementById("fileBrowserLink").addEventListener("click", browseFiles, false);
	loadImage();
}
</script>
</head>
<body onload="bodyLoaded()">

<div id="photoDiv"><img id="photo" /></div>
<div id="cropper">
<div id="resizeNW"></div>
<div id="resizeNE"></div>
<div id="resizeSW"></div>
<div id="resizeSE"></div>
</div>

<div id="controlDiv">
Crop Area (Width x Height + X + Y): <input
	type="text" id="cropWidthField" size="4" value="" onchange="changeCropWidth()" />x<input
	type="text" id="cropHeightField" size="4" value="" onchange="changeCropHeight()" />+<input
	type="text" id="cropXField" size="4" value="" onchange="changeCropX()" />+<input
	type="text" id="cropYField" size="4" value="" onchange="changeCropY()" />
<br>
<input type="button" value="Crop" onclick="crop()" />
<input type="button" value="Undo" onclick="undo()" />
<input type="button" value="Rotate Left" onclick="rotatePhoto(270)" />
<input type="button" value="Rotate Right" onclick="rotatePhoto(90)" />
<input type="button" value="Rotate 180" onclick="rotatePhoto(180)" />
<br>
Display Width x Height: <input
	type="text" readonly id="divWidth" size="4" value="" />x<input
	type="text" readonly id="divHeight" size="4" value="" />
<span id="aspectRatio">(:)</span>
<br>
<input type="checkbox" id="inverseAspectRatioCheckbox" onclick="toggleInverseAspectRatio()" />
Crop Inverse Aspect Ratio
&nbsp;&nbsp;<a href="#" id="toggleFiltersLink">Hide Filters</a>
&nbsp;&nbsp;<a href="#" id="fileBrowserLink">Browse Files</a>
<br>
<input type="file" id="fileBrowser" accept="image/*" multiple onchange="loadFiles()" />
<select id="fileNameField" onchange="loadImage()"></select>
<input type="button" id="prevButton" value="Previous" onclick="prevImage()" />
<input type="button" id="nextButton" value="Next" onclick="nextImage()" />
<a download href="#" id="downloadLink">Save</a>
<br>
<input type="text" id="specParam" size="44" value="" readonly />
<div id="filterDiv"></div>
</div>

<div id="statusDiv"><span id="statusText">Loading</span><div id="spinDisc"></div></div>
<canvas id="canvas"></canvas>
</body>
</html>
